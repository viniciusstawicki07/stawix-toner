{% extends "tabela_base.html" %}

{% block title %}Administração de Pedidos{% endblock %}
{% block page_title %}Administração de Pedidos{% endblock %}
{% block home_link %}{{ url_for('admin_page') }}{% endblock %}

{% block scripts %}
<script>
    // Funções de Ação
    function cancelarPedido(pedidoId) {
        Swal.fire({
            title: 'Tem certeza?', text: "Deseja cancelar este pedido?", icon: 'warning',
            showCancelButton: true, confirmButtonText: 'Sim, cancelar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/cancelar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }
    function enviarPedido(pedidoId) {
        Swal.fire({
            title: 'Confirmar envio?', text: "Deseja enviar este pedido?", icon: 'info',
            showCancelButton: true, confirmButtonText: 'Sim, enviar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/enviar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }

    $(document).ready(function() {
        let table = $('#tabela-pedidos').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "{{ url_for('dados_pedidos_admin') }}",
            "columns": [
                { "data": "pedido_id" }, { "data": "nomeFunc" }, { "data": "Entreposto" },
                { "data": "Setor" }, { "data": "Impressora" }, { "data": "Quantidade" },
                { "data": "Status" }, { "data": "data_pedido" }, { "data": "acoes" }
            ],
            "columnDefs": [
                { "width": "50px", "targets": [0, 5] },
                { "width": "120px", "targets": [6, 7, 8] },
                { "orderable": false, "targets": [1, 2, 3, 4, 6, 8] }
            ],
            "order": [[ 0, "desc" ]],
            "pageLength": 15,
            "scrollY": "calc(100vh - 340px)",
            "scrollX": false, // Desativa a rolagem horizontal
            "scrollCollapse": true,
            "language": { "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json" },
            // Cria os botões de ação na coluna 'Ações'
            "createdRow": function( row, data, dataIndex ) {
                if (data.Status === 'Não Enviado') {
                    $('td', row).eq(8).html(
                        `<div class="action-buttons-container">
                            <button class="dt-button-cancel" onclick="cancelarPedido(${data.pedido_id})">Cancelar</button>
                            <button class="dt-button-send" onclick="enviarPedido(${data.pedido_id})">Enviar</button>
                        </div>`
                    );
                }
            }
        });

        // --- LÓGICA DOS FILTROS POP-UP ---
        let activeFilters = {};

        // Busca as opções de filtro uma única vez
        let filterOptions = {};
        fetch("{{ url_for('get_filter_options') }}")
            .then(response => response.json())
            .then(data => filterOptions = data);

        // Função para criar o conteúdo do pop-up
        function renderFilterPopup(columnName) {
            const popup = $(`#filter-popup-${columnName}`);
            popup.empty(); // Limpa o conteúdo anterior

            if (columnName === 'nomeFunc') {
                popup.append(`<h4>Pesquisar por Nome</h4>`);
                popup.append(`<input type="text" id="search-${columnName}" value="${activeFilters[columnName] || ''}">`);
            } else {
                popup.append(`<h4>Filtrar por ${columnName}</h4>`);
                const optionsDiv = $('<div class="filter-options"></div>');
                const options = filterOptions[columnName.toLowerCase() + 's'] || filterOptions[columnName.toLowerCase()];
                options.forEach(val => {
                    const isChecked = activeFilters[columnName] && activeFilters[columnName].includes(val);
                    optionsDiv.append(`<label><input type="checkbox" value="${val}" ${isChecked ? 'checked' : ''}> ${val}</label>`);
                });
                popup.append(optionsDiv);
            }

            // Ações (botões)
            popup.append(
                `<div class="filter-actions">
                    <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                    <button class="btn-apply" onclick="applyColumnFilter('${columnName}')">Filtrar</button>
                </div>`
            );
        }

        // Evento de clique nos botões de filtro
        $('.filter-btn').on('click', function(e) {
            e.stopPropagation();
            const colName = $(this).data('filter');
            $('.filter-popup').not(`#filter-popup-${colName}`).removeClass('active');
            renderFilterPopup(colName);
            $(`#filter-popup-${colName}`).toggleClass('active');
        });

        // Fechar pop-ups ao clicar fora
        $(document).on('click', function() {
            $('.filter-popup').removeClass('active');
        });
        $('.filter-popup').on('click', function(e) {
            e.stopPropagation();
        });

        // Funções globais para aplicar/limpar filtros
        window.applyColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            if (colName === 'nomeFunc') {
                activeFilters[colName] = $(`#search-${colName}`).val();
                table.column(colIndex).search(activeFilters[colName]).draw();
            } else {
                activeFilters[colName] = $(`#filter-popup-${colName} input:checked`).map(function() { return this.value; }).get();
                const searchString = activeFilters[colName].map(v => `^${v}$`).join('|');
                table.column(colIndex).search(searchString, true, false).draw();
            }
            $('.filter-popup').removeClass('active');
        }

        window.clearColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            activeFilters[colName] = [];
            table.column(colIndex).search('').draw();
            $('.filter-popup').removeClass('active');
        }
    });
</script>
{% endblock %}