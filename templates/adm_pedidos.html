{% extends "tabela_base.html" %}

{% block title %}Administração de Pedidos{% endblock %}
{% block page_title %}Administração de Pedidos{% endblock %}
{% block home_link %}{{ url_for('admin_page') }}{% endblock %}

{% block scripts %}
<script>
    // Funções de Ação
    function cancelarPedido(pedidoId) {
        Swal.fire({
            title: 'Tem certeza?', text: "Deseja cancelar este pedido?", icon: 'warning',
            showCancelButton: true, confirmButtonText: 'Sim, cancelar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/cancelar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }
    function enviarPedido(pedidoId) {
        Swal.fire({
            title: 'Confirmar envio?', text: "Deseja enviar este pedido?", icon: 'info',
            showCancelButton: true, confirmButtonText: 'Sim, enviar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/enviar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }

    $(document).ready(function() {
        // CORREÇÃO: Adicionada a propriedade 'name' a cada coluna para o seletor funcionar.
        let table = $('#tabela-pedidos').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "{{ url_for('dados_pedidos_admin') }}",
            "columns": [
                { "data": "pedido_id", "name": "pedido_id" }, 
                { "data": "nomeFunc", "name": "nomeFunc" }, 
                { "data": "Entreposto", "name": "Entreposto" },
                { "data": "Setor", "name": "Setor" }, 
                { "data": "Impressora", "name": "Impressora" }, 
                { "data": "Quantidade", "name": "Quantidade" },
                { "data": "Status", "name": "Status" }, 
                { "data": "data_pedido", "name": "data_pedido" }, 
                { "data": "acoes", "name": "acoes" }
            ],
            "columnDefs": [
                { "width": "50px", "targets": [0, 5] },
                { "width": "120px", "targets": [6, 7, 8] },
                { "orderable": false, "targets": [1, 2, 3, 4, 6, 8] }
            ],
            "order": [[ 0, "desc" ]],
            "pageLength": 15,
            "scrollY": "calc(100vh - 340px)",
            "scrollX": false,
            "scrollCollapse": true,
            "language": { "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json" },
            "createdRow": function( row, data, dataIndex ) {
                if (data.Status === 'Não Enviado') {
                    // Limpa o conteúdo e adiciona os botões
                    $('td', row).eq(8).empty().append(
                        $('<div class="action-buttons-container"></div>').append(
                            $('<button class="dt-button-cancel">Cancelar</button>').on('click', function() { cancelarPedido(data.pedido_id); }),
                            $('<button class="dt-button-send">Enviar</button>').on('click', function() { enviarPedido(data.pedido_id); })
                        )
                    );
                }
            }
        });

        // --- LÓGICA DOS FILTROS POP-UP ---
        let activeFilters = {};
        let filterOptions = {};
        fetch("{{ url_for('get_filter_options') }}")
            .then(response => response.json())
            .then(data => filterOptions = data);

        function renderFilterPopup(columnName) {
            const popup = $(`#filter-popup-${columnName}`);
            popup.empty();
            if (columnName === 'nomeFunc') {
                popup.append(`<h4>Pesquisar por Nome</h4>`);
                popup.append(`<input type="text" id="search-${columnName}" value="${activeFilters[columnName] || ''}">`);
            } else {
                popup.append(`<h4>Filtrar por ${columnName}</h4>`);
                const optionsDiv = $('<div class="filter-options"></div>');
                const optionsKey = columnName.toLowerCase() + 's';
                const options = filterOptions[optionsKey] || filterOptions[columnName.toLowerCase()];
                if(options) {
                    options.forEach(val => {
                        const isChecked = activeFilters[columnName] && activeFilters[columnName].includes(val);
                        optionsDiv.append(`<label><input type="checkbox" value="${val}" ${isChecked ? 'checked' : ''}> ${val}</label>`);
                    });
                }
                popup.append(optionsDiv);
            }
            popup.append(
                `<div class="filter-actions">
                    <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                    <button class="btn-apply" onclick="applyColumnFilter('${columnName}')">Filtrar</button>
                </div>`
            );
        }

        $('#tabela-pedidos').on('click', '.filter-btn', function(e) {
            e.stopPropagation();
            const colName = $(this).data('filter');
            $('.filter-popup').not(`#filter-popup-${colName}`).removeClass('active');
            renderFilterPopup(colName);
            $(`#filter-popup-${colName}`).toggleClass('active');
        });

        $(document).on('click', function() { $('.filter-popup').removeClass('active'); });
        $('.filter-popup').on('click', function(e) { e.stopPropagation(); });

        window.applyColumnFilter = function(colName) {
            // CORREÇÃO: Usar o seletor :name para encontrar o índice correto da coluna
            const colIndex = table.column(`${colName}:name`).index();
            if (colName === 'nomeFunc') {
                activeFilters[colName] = $(`#search-${colName}`).val();
                table.column(colIndex).search(activeFilters[colName]).draw();
            } else {
                activeFilters[colName] = $(`#filter-popup-${colName} input:checked`).map(function() { return this.value; }).get();
                const searchString = activeFilters[colName].map(v => `^${v}$`).join('|');
                table.column(colIndex).search(searchString, true, false).draw();
            }
            $('.filter-popup').removeClass('active');
        }

        window.clearColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            activeFilters[colName] = [];
            table.column(colIndex).search('').draw();
            $('.filter-popup').removeClass('active');
        }
    });
</script>
{% endblock %}
