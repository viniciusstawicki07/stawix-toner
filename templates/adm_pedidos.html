{% extends "tabela_base.html" %}

{% block title %}Administração de Pedidos{% endblock %}
{% block page_title %}Administração de Pedidos{% endblock %}
{% block home_link %}{{ url_for('admin_page') }}{% endblock %}

{% block scripts %}
<script>
    // Funções de Ação (sem alteração)
    function cancelarPedido(pedidoId) {
        Swal.fire({
            title: 'Tem certeza?', text: "Deseja cancelar este pedido?", icon: 'warning',
            showCancelButton: true, confirmButtonText: 'Sim, cancelar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/cancelar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }
    function enviarPedido(pedidoId) {
        Swal.fire({
            title: 'Confirmar envio?', text: "Deseja enviar este pedido?", icon: 'info',
            showCancelButton: true, confirmButtonText: 'Sim, enviar!', cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/enviar_pedido/${pedidoId}`, { method: 'POST' })
                .then(r => r.json()).then(d => {
                    if(d.success) $('#tabela-pedidos').DataTable().ajax.reload(null, false);
                });
            }
        });
    }

    $(document).ready(function() {
        let table = $('#tabela-pedidos').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "{{ url_for('dados_pedidos_admin') }}",
            "columns": [
                { "data": "pedido_id", "name": "pedido_id" },
                { "data": "nomeFunc", "name": "nomeFunc" },
                { "data": "Entreposto", "name": "Entreposto" },
                { "data": "Setor", "name": "Setor" },
                { "data": "Impressora", "name": "Impressora" },
                { "data": "Quantidade", "name": "Quantidade" },
                { "data": "Status", "name": "Status" },
                { "data": "data_pedido", "name": "data_pedido" },
                { "data": "acoes", "name": "acoes" }
            ],
            "columnDefs": [
                { "width": "50px", "targets": [0, 5] },
                { "width": "120px", "targets": [6, 7, 8] },
                { "orderable": false, "targets": [1, 2, 3, 4, 6, 7, 8] }
            ],
            "order": [[ 0, "desc" ]],
            "pageLength": 15,
            "scrollY": "calc(100vh - 400px)", // Ajuste de altura para o novo layout
            "scrollX": false,
            "scrollCollapse": true,
            "language": { "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json" },
            // CORREÇÃO: Lógica para colorir o status
            "createdRow": function( row, data, dataIndex ) {
                // Colore a célula de Status
                const statusCell = $('td', row).eq(6);
                if (data.Status === 'Não Enviado') {
                    statusCell.addClass('status-nao-enviado');
                } else if (data.Status === 'Enviado') {
                    statusCell.addClass('status-enviado');
                } else if (data.Status === 'Cancelado') {
                    statusCell.addClass('status-cancelado');
                }
                
                // Renderiza botões de ação
                if (data.acoes && data.acoes !== '-') {
                     $('td', row).eq(8).html(data.acoes);
                }
            }
        });

        // --- LÓGICA DOS FILTROS POP-UP (sem alterações) ---
        let activeFilters = {};
        let filterOptions = {};
        let filtersLoaded = false;
        const popup = $('#the-filter-popup');

        fetch("{{ url_for('get_filter_options') }}")
            .then(response => response.json())
            .then(data => {
                filterOptions = data;
                filtersLoaded = true;
            });

        function renderFilterPopup(columnName, button) {
            popup.empty();

            if (!filtersLoaded) {
                popup.append('<h4>Carregando...</h4>');
                return;
            }
            
            if (columnName === 'data_pedido') {
                popup.append(`<h4>Filtrar por Período</h4>`);
                popup.append(`<label for="date-start">De:</label><input type="date" id="date-start">`);
                popup.append(`<label for="date-end">Até:</label><input type="date" id="date-end">`);
                popup.append(`
                    <div class="filter-actions" style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="btn-sort-group">
                            <button class="btn-sort-small" onclick="sortByDate('desc')">Mais Novo</button>
                            <button class="btn-sort-small" onclick="sortByDate('asc')">Mais Antigo</button>
                        </div>
                        <div>
                            <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                            <button class="btn-apply" onclick="applyDateFilter()">Aplicar</button>
                        </div>
                    </div>
                `);
            } else if (columnName === 'nomeFunc') {
                popup.append(`<h4>Pesquisar por Nome</h4>`);
                popup.append(`<input type="text" id="search-${columnName}" value="${activeFilters[columnName] || ''}" placeholder="Digite um nome...">`);
                popup.append(
                    `<div class="filter-actions">
                        <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                        <button class="btn-apply" onclick="applyColumnFilter('${columnName}')">Aplicar</button>
                    </div>`
                );
            } else {
                popup.append(`<h4>Filtrar por ${columnName}</h4>`);
                const optionsDiv = $('<div class="filter-options"></div>');
                let optionsKey;
                const lowerColumnName = columnName.toLowerCase();
                if (lowerColumnName === 'setor') optionsKey = 'setores';
                else if (lowerColumnName === 'status') optionsKey = 'status';
                else optionsKey = lowerColumnName + 's';
                
                const options = filterOptions[optionsKey];
                if (options) {
                    options.forEach(val => {
                        const isChecked = activeFilters[columnName] && activeFilters[columnName].includes(val);
                        optionsDiv.append(`<label><input type="checkbox" value="${val}" ${isChecked ? 'checked' : ''}> ${val}</label>`);
                    });
                }
                popup.append(optionsDiv);
                popup.append(
                    `<div class="filter-actions">
                        <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                        <button class="btn-apply" onclick="applyColumnFilter('${columnName}')">Aplicar</button>
                    </div>`
                );
            }

            const container = $('.menu-container-pedidos');
            const buttonOffset = button.offset();
            const containerOffset = container.offset();
            const topPos = buttonOffset.top - containerOffset.top + button.outerHeight();
            const leftPos = buttonOffset.left - containerOffset.left;

            popup.css({ top: topPos + 'px', left: leftPos + 'px' }).addClass('active').show();
        }

        $(document).on('click', '#tabela-pedidos_wrapper .filter-btn', function(e) {
            e.stopPropagation();
            const button = $(this);
            const colName = button.data('filter');

            if (popup.is(':visible') && popup.data('current-filter') === colName) {
                popup.hide().removeClass('active');
            } else {
                popup.data('current-filter', colName);
                renderFilterPopup(colName, button);
            }
        });

        $(document).on('click', function(e) {
            if (!popup.is(e.target) && popup.has(e.target).length === 0 && popup.is(':visible')) {
                popup.hide().removeClass('active');
            }
        });
        popup.on('click', function(e) { e.stopPropagation(); });
        
        window.sortByDate = function(direction) {
            const colIndex = table.column('data_pedido:name').index();
            table.order([colIndex, direction]).draw();
            popup.hide().removeClass('active');
        }
        
        window.applyDateFilter = function() {
            const colIndex = table.column('data_pedido:name').index();
            const startDate = $('#date-start').val();
            const endDate = $('#date-end').val();
            let dateRange = '';
            if (startDate && endDate) {
                dateRange = `${startDate} to ${endDate}`;
            }
            table.column(colIndex).search(dateRange).draw();
            popup.hide().removeClass('active');
        }

        window.applyColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            if (colName === 'nomeFunc') {
                activeFilters[colName] = $(`#search-${colName}`).val();
                table.column(colIndex).search(activeFilters[colName]).draw();
            } else {
                activeFilters[colName] = $(`#the-filter-popup input:checked`).map(function() { return this.value; }).get();
                let searchString;
                if (colName === 'Status') {
                    searchString = activeFilters[colName].map(val => `^${val}$`).join('|');
                } else {
                    searchString = activeFilters[colName].join('|');
                }
                table.column(colIndex).search(searchString, true, false).draw();
            }
            popup.hide().removeClass('active');
        }

        window.clearColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            activeFilters[colName] = [];
            table.column(colIndex).search('').draw();
            if (colName === 'data_pedido') {
                $('#date-start').val('');
                $('#date-end').val('');
            }
            popup.hide().removeClass('active');
        }
    });
</script>
{% endblock %}