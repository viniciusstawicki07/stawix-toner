{% extends "tabela_base.html" %}

{% block title %}Meus Pedidos{% endblock %}
{% block page_title %}Meus Pedidos{% endblock %}
{% block home_link %}{{ url_for('index') }}{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        let table = $('#tabela-pedidos').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "{{ url_for('dados_meus_pedidos') }}",
            "columns": [
                { "data": "pedido_id", "name": "pedido_id" },
                { "data": "nomeFunc", "name": "nomeFunc" },
                { "data": "Entreposto", "name": "Entreposto" },
                { "data": "Setor", "name": "Setor" },
                { "data": "Impressora", "name": "Impressora" },
                { "data": "Quantidade", "name": "Quantidade" },
                { "data": "Status", "name": "Status" },
                { "data": "data_pedido", "name": "data_pedido" }
            ],
            "columnDefs": [
                { "width": "50px", "targets": [0, 5] },
                { "width": "120px", "targets": [6, 7] },
                { "orderable": false, "targets": [1, 2, 3, 4, 6] }
            ],
            "order": [[ 0, "desc" ]],
            "pageLength": 15,
            "scrollY": "calc(100vh - 340px)",
            "scrollX": false,
            "scrollCollapse": true,
            "language": { "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json" }
        });

        // --- LÓGICA DOS FILTROS POP-UP ---
        let activeFilters = {};
        let filterOptions = {};
        let filtersLoaded = false;
        const popup = $('#the-filter-popup');

        fetch("{{ url_for('get_filter_options') }}")
            .then(response => response.json())
            .then(data => {
                filterOptions = data;
                filtersLoaded = true;
            });

        function renderFilterPopup(columnName, button) {
            popup.empty();

            if (!filtersLoaded) {
                popup.append('<h4>Carregando...</h4>');
                return;
            }

            if (columnName === 'nomeFunc') {
                popup.append(`<h4>Pesquisar por Nome</h4>`);
                popup.append(`<input type="text" id="search-${columnName}" value="${activeFilters[columnName] || ''}" placeholder="Digite um nome...">`);
            } else {
                popup.append(`<h4>Filtrar por ${columnName}</h4>`);
                const optionsDiv = $('<div class="filter-options"></div>');

                // CORREÇÃO: Lógica para encontrar a chave correta (ex: 'setores')
                let optionsKey;
                const lowerColumnName = columnName.toLowerCase();
                if (lowerColumnName === 'setor') {
                    optionsKey = 'setores';
                } else if (lowerColumnName === 'status') {
                    optionsKey = 'status';
                } else {
                    optionsKey = lowerColumnName + 's';
                }

                const options = filterOptions[optionsKey];
                if (options) {
                    options.forEach(val => {
                        const isChecked = activeFilters[columnName] && activeFilters[columnName].includes(val);
                        optionsDiv.append(`<label><input type="checkbox" value="${val}" ${isChecked ? 'checked' : ''}> ${val}</label>`);
                    });
                }
                popup.append(optionsDiv);
            }
            popup.append(
                `<div class="filter-actions">
                    <button class="btn-clear" onclick="clearColumnFilter('${columnName}')">Limpar</button>
                    <button class="btn-apply" onclick="applyColumnFilter('${columnName}')">Aplicar</button>
                </div>`
            );
            
            const container = $('.menu-container-pedidos');
            const buttonOffset = button.offset();
            const containerOffset = container.offset();
            const topPos = buttonOffset.top - containerOffset.top + button.outerHeight();
            const leftPos = buttonOffset.left - containerOffset.left;

            popup.css({
                top: topPos + 'px',
                left: leftPos + 'px'
            }).addClass('active').show();
        }

        $(document).on('click', '#tabela-pedidos_wrapper .filter-btn', function(e) {
            e.stopPropagation();
            const button = $(this);
            const colName = button.data('filter');

            if (popup.is(':visible') && popup.data('current-filter') === colName) {
                popup.hide().removeClass('active');
            } else {
                popup.data('current-filter', colName);
                renderFilterPopup(colName, button);
            }
        });

        $(document).on('click', function(e) {
            if (!popup.is(e.target) && popup.has(e.target).length === 0 && popup.is(':visible')) {
                popup.hide().removeClass('active');
            }
        });
        popup.on('click', function(e) { e.stopPropagation(); });

        window.applyColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            if (colName === 'nomeFunc') {
                activeFilters[colName] = $(`#search-${colName}`).val();
                table.column(colIndex).search(activeFilters[colName]).draw();
            } else {
                activeFilters[colName] = $(`#the-filter-popup input:checked`).map(function() { return this.value; }).get();
                
                let searchString;
                if (colName === 'Status') {
                    searchString = activeFilters[colName].map(val => `^${val}$`).join('|');
                } else {
                    searchString = activeFilters[colName].join('|');
                }
                
                table.column(colIndex).search(searchString, true, false).draw();
            }
            popup.hide().removeClass('active');
        }

        window.clearColumnFilter = function(colName) {
            const colIndex = table.column(`${colName}:name`).index();
            activeFilters[colName] = [];
            table.column(colIndex).search('').draw();
            popup.hide().removeClass('active');
        }
    });
</script>
{% endblock %}